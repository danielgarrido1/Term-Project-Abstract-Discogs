CREATE EXTERNAL TABLE IF NOT EXISTS country_yearly_genre_analysis (year DATE, country STRING, genre STRING, genre_count BIGINT) ROW FORMAT DELIMITED FIELDS TERMINATED BY '|' STORED AS TEXTFILE LOCATION '/user/gmunoz58/CountryYearlyGenreAnalysis/’;

INSERT OVERWRITE TABLE country_yearly_genre_analysis SELECT CONCAT(release_date, '-01-01') AS year, country, genre, genre_count FROM ( SELECT release_date, country, genre, count() AS genre_count, RANK() OVER(PARTITION BY country, release_date ORDER BY count() DESC) AS genre_ranks FROM plzwork WHERE release_date >= 1922 AND release_date <= 2022 AND country IN ('US','UK','Germany','Japan','France','Italy','Canada','Netherlands','Spain','Australia') GROUP BY release_date, country, genre) AS ranked_genres_yearly WHERE genre_ranks <= 5 ORDER BY release_date, country, genre_ranks;
